import numpy as np
from scipy.interpolate import interp1d
import xarray as xr
from xnoah.xarray import map_overlap
import dask.array as da
from dask.array.core import atop
from dask import delayed

import lib.models as models

configfile: "config.yaml"
include: "sam.rules"
include: "jupyter.rules"


rule all:
    input: "01-cross-validation-mca-ridge.done"

@wrap_xarray_calculation
def source(x, f):
    dt = float(x.time[1] - x.time[0])
    return x.shift(time=-1) - dt/2 * (f.shift(time=-1) + f)

def mysel(x):
    return x.sel(time=slice(20,None)).isel(x=slice(0,100))

rule inputs:
    input: "calc/qt.nc", "calc/sl.nc", "A64/2d/LHF.nc", "A64/2d/SHF.nc"
    output: "ml/X.nc"
    run:
        xr.merge((xopena(f) for f in input), join='inner')\
          .pipe(mysel)\
          .to_netcdf(output[0])

rule outputs:
    input: q2="budget/calc/qt.nc", q1="budget/calc/sl.nc"
    output: Y="ml/Y.nc"
    run:
        data_vars = dict(q1=xopena(input.q1),
                         q2=xopena(input.q2) * Lc / cp * 1e-3)

        xr.Dataset(data_vars).pipe(mysel).to_netcdf(output.Y)

rule test_train_split:
    input: "{f}.nc"
    output: train="train/{f}.nc", test="test/{f}.nc"
    params: t_split=70.0
    script: "test_train_split.py"


rule cross_validate:
    input: input_train="train/ml/X.nc", output_train="train/ml/Y.nc",
           input_test="test/ml/X.nc", output_test="test/ml/Y.nc",
           weight="w.nc"
    output: model="cv/{model}/model.pkl",
            cv="cv/{model}/cv.json",
            prediction="cv/{model}/pred.nc",
            residual="cv/{model}/resid.nc"
    params: model=lambda wildcards: models.model_dict[wildcards.model],
            sample_dims=['x', 'time']
    script: "cross_validate.py"


from sklearn.linear_model import Ridge
rule fit:
    input: input="ml/X.nc", output="ml/Y.nc",
            weight="w.nc"
    output: model="ml/model.pkl"
            # prediction="ml/pred.nc",
            # residual="ml/resid.nc"
    params: model=Ridge(.19), sample_dims=['x', 'time']
    script: "fit.py"
